# Tutorial 2: Training EDDP, structure searching with EDDP on LiH

## 1\. Training a Small EDDP

EDDPs are a lightweight neural network potential designed specifically to accelerate structure prediction. They are closely integrated with AIRSS; in fact, we need only very slightly adapt the input files we used in Tutorial 1 to train our potential! The EDDP training is an iterative process. It begins with a number of random sensible structures generated by `buildcell`, on which a first potential is trained. Then, this potential is used, in effect, to carry out a series of small structure searches which add further data on which to train new potentials. A big speed-up over AIRSS results from the fact that no DFT geometry optimisations are ever carried out - only DFT single-point calculations are necessary to generate training data. Make sure you make the corresponding change in `LiH.param`! You may also want to delete the parameters we used to customise the AIRSS geometry optimisation. Leave `write_cell_structure : true`, though.

### Setup and training

Make a new directory in which to train the potential. One particular strength of the EDDP is the ability to train on small but diverse unit cells. Therefore, the only change necessary compared to the AIRSS search in the last tutorial is potentially reducing the number of formula units (depending on how large you made your search cells). Set `#NFORM=1-4` in `LiH.cell`. This should be more than sufficient to generate a good potential.

The `chain` script is used to run all the different aspects of developing a machine-learned potential. You begin with `LiH.cell` and `LiH.param`, run `chain`, and end up with `LiH.eddp`! While your potential is training, you may wish to take a moment to read the chain source code to train and understand what it does. For the moment, type `chain -h` to see a list of parameters and their definitions. Some of the most important are the cut off radius, `-r`, and the number of polynomials, `-P`. Consider what values you should set for them. Usually, to generate a high-quality EDDP for a system such as LiH, I might use O(10 000) structures. Unfortunately, given the time and computational resources available for this practical, you will not be able to generate this much training data. To train a small potential, set `-f 100 -n 2 -m 50 -N 5` in your `chain` command. Try and understand what kind of potential this will create. You will want your chain script to be running in the background. To launch the potential training process, type `nohup chain <parameters> &`.\
If you want to look at the chain source code type `vim $(which chain)` .

### Evaluating your potential

Before running any calculations, you can draw some conclusions about the quality of your potential. Look at the\
`nohup.out` file. At its beginning, we find a helpful summary of all the input parameters and the command used to launch the training. At its bottom, you will find a list of EDDP prediction errors. There are two different types of error, the MAE and the RMSE. Do you understand the difference between these errors? Which do you think is more important for determining your potential's quality? How large are they? Is any one of them significantly larger than the other? If the testing error is much larger than the training error, this suggests a phenomenon known as *overfitting*. This occurs when the potential learns the structures in its training set 'too' well, at the expense of its ability to describe 'unseen' structures, which are contained in the testing set. Is your potential overfit? If so, how might we avoid this? Do you think a large error necessarily implies a bad potential, and a small error a good one? Why / why not?

Another important tool for evaluating a potential are the so-called *parity plots*. They plot the EDDP prediction for a structure's energy on the y-axis, against the DFT-calculated energy on the x-axis. Ideally, they would follow a straight line. You can find the parity plots in `plots/flock-*.agr`. Plot them with `xmgrace`. How far off the ideal are your parity plots? Also in the plots directory are `flock-*.delta`. These plot the EDDP errors as a function of DFT energy, and plot the cumulative MAE and RMSE. Have a look at those as well to determine where your error comes from. Is there a region causing any particular spikes? If so, what does this mean for your interpretation of your errors, and how we might go about improving our potential?

The ultimate test of a potential's suitability is its appropriateness for a particular, chosen task. Try and carry out a structure search with your potential. To do so, make a new directory, into which you put the `LiH.cell` and `LiH.param`files from before, alongside the `LiH.eddp` file and the `LiH` directory. Look at `LiH.eddp`. It points to files in the `LiH`directory. These `.ddp` files contain the actual parameters for the neural network. Have a look at one of them. We train a fairly large number of these during one EDDP training cycle. `LiH.eddp` combines the best `.ddp` files with the specified small positive weights to generate an ensemble of potentials. Together, the `LiH` directory and `LiH.eddp` can be thought of as forming your EDDP. In the new directory, launch an AIRSS search. You need to specify the `-repose` parameter for AIRSS to use EDDPs[1]. `repose` is the EDDP geometry optimiser. The EDDPs should be a lot faster than CASTEP, so you can also set `-mpinp 1`. This search should not take longer than a minute or so. Terminate it with `despawn`. Have you found the Fm-3m structure?

If you do find it, you may notice that it is quite far (several eV/fu) from the ground state. This is likely to do with pathologies in your potential, regions where it is badly constrained. There are two techniques to deal with this: The first is DFT refinement (which you will probably want to do anyways). We will see how to do this in section 2. The second is to exploit a property of the EDDPs. They are ensembles (weighted averages) of many individual neural networks, which allows us to calculate standard deviations. Those arrangements with high standard deviations are those where the potential is badly constrained and therefore likely (though not necessarily) pathological and incorrect. We can use this to filter pathological structures from the search with the `-devmax` parameter from AIRSS. You can use `res2dev <seed>`to calculate the ensemble deviation for any` <seed>.res` file. Use it to check a few of the extremely low-energy structures, and compare them to the Fm-3m structure. On the basis of this, you should be able to determine a good value for\
`-devmax` with which to run a new search. Note that `res2dev` returns the deviation *per cell*, whereas `-devmax` needs it *per formula unit*. Since the calculations are so fast, you can try a few settings, if you like.

## 2\. Structure searching with EDDP and refinement

You should not expect your EDDP trained in section 1 to be particularly robust. For this reason, we have provided a pre-trained LiH EDDP for you to use for some more sophisticated tasks. For this EDDP, we have prioritised speed over the highest accuracy, but it should give physically sensible results. You can find the potential's files in `LiH_section_2/EDDP`. In `LiH_section_2`, you will also see a .cell file and a shell script. These will come in useful later.

Use your new LiH EDDP to carry out a similar structure search as you did in section 1. Compare the two datasets. Do you find the Fm-3m structure this time? Do you find it more or less frequently? Owing to the acceleration provided by the EDDPs, we can use them to explore much wider regions of structure space. The EDDP you were provided with for this task was trained on a range of stoichiometries, covering 3-9 atoms each of both Li and H. Thus, it should comfortably handle stoichiometries covering the range Li_{1-3}H_{1-3}. Carry out a search on this range of stoichiometries. Can you see the change(s) you need to make in `LiH.cell` in order to enable this?

The energies of systems with different stoichiometries cannot be directly compared against one another because the energies of hydrogen and lithium atoms have completely different references. However, we can construct a *so-called*convex hull, which plots the formation enthalpy of different stoichiometries compared to the end members of the hull. Any composition and structure *on*the hull is thermodynamically stable. Which thermodynamically stable composition will be formed depends on the experimental conditions. You can plot the convex hull using `ca -m` and xmgrace to visualise it.

For a system with an unknown ground state, we have to be conscious that the EDDP might predict the wrong ground state; after all it is not a perfect reproduction of DFT. An EDDP-driven structure prediction run will therefore use the EDDP as an initial step, as a way of determining which structures are *good*, rather than necessarily the perfect ranking. Fortunately, it is easy to carry out DFT refinement of the favourable structures. For this, we can use the AIRSS `crud.pl`tool. It launches a defined CASTEP calculation on a chosen set of structures. As alluded to in section 1, a similar workflow, though for different reasons, is necessary when using underconverged DFT calculations for searches optimised for speed.\
`crud.pl` requires 3 ingredients which you must place in a directory. Firstly, a `.param` file, which defines the calculation as always. Secondly, a rump .cell file is necessary. It contains all parameters you would usually find in a `.cell` file *except*the structures. You can simply use the .cell file we have been using for our AIRSS searches - since they are prefixed with a `#`, the AIRSS commands will be ignored by CASTEP.

For the refinement step, it is sensible to carry out high-quality calculations. You will therefore want to increase the k-point sampling (smaller `K_POINTS_SPACING`) and plane-wave cutoff energy (in eV). Depending on how much time is left in the practical, you may choose to carry out a proper convergence test (and in the 'real world', you always should!). If time is tight, use your intuition and select sensibly high values. The `QC5` pseudopotential used for the AIRSS search is particularly soft. Use a more standard pseudopotential for high-quality calculations (you can use `C19`for example).\
Refinement of our structures means finding the actual minimum in the DFT energy landscape, which can differ slightly from the EDDP minimum. In other words, we need to run geometry optimisations. You will want to use a more general approach for this task here than the one employed in AIRSS. Consider what values you want to set for the relevant parameters in `LiH.param` (mostly the defaults are fine). You may also want to turn on the semi-empirical dispersion correction (SEDC) to capture long-range electrostatics. Can you figure out which parameters you need for this?

Finally, the `hopper` directory contains all the structures we want to operate on with the CASTEP calculation defined by `LiH.cell` and `LiH.param`. They must be in the AIRSS `.res` format. Pick the 5 most interesting structures for each stoichiometry from your EDDP-driven search and copy them into `hopper`. Take a moment to consider which these are. Here, we use a fixed number of structures to ensure the calculations don't take too long. Are there other ways of making this choice? Launch your calculation from the directory containing `LiH.cell`, `LiH.param`, and `hopper`. Type `crud.pl -h` to help you understand which flags you need to set. Once again, you can use `spawn` to launch `crud.pl`. When your calculations are completed, look at your structures. Are they very different from the ones predicted by the EDDP? Can you find analogous structures in the dataset from previous search? How do these compare? Plot the convex hull again with `ca -m`. Is it different from the hull predicted by the EDDP?

## 3\. Bonus: Molecular dynamics - melting point of LiH with EDDP

The EDDP you have been supplied with is high-quality and can be employed for many different tasks. To terminate this practical, we will carry out a molecular dynamics (MD) simulation in order to calculate the melting point of Fm-3m LiH. The type of simulation we will carry out is known as *coexistence molecular dynamics*. It works by simulating the interactions between a crystal's solid and liquid phases in the NPH ensemble.[2] As the two phases exchange energy with each other, the temperature naturally tends to the melting point. If you find a stable long-run coexistence of the two phases, you have discovered the melting point!\
The EDDPs come with a built-in MD code, `ramble`. The `run_coex.sh` script calls `ramble` with parameters chosen to allow you to reach a stable coexistence. Make sure you read the script and understand why you have rename `LiH.res`, and what to. As you might expect by now, you can use `ramble -h` to help you understand these parameters. The `LiH-coex.cell` file in `LiH_section_3` contains 1040 formula units of LiH. Half of these, roughly, are in the solid, and the other half in the liquid phase. Use this structure for your MD simulation. Make again a new directory with LiH.cell, the EDDP files from within `LiH_section_3/EDDP`, and the run script `run_coex.sh`. You can then launch the calculation with `nohup ./run_coex.sh &`.\
You can monitor your job as it runs. In particular, `LiH-coex.track` stores the important properties characterising the system over time. You can plot it using `xmgrace -nxy LiH.track`. In the plot, the volume will be in black, the actual and target temperatures in red and green respectively, and the actual and target pressures in blue and yellow. The atomic positions themselves are stored in `LiH-coex.xyze` and `LiH-coex-run.xyze`. The latter file stores the positions as a running average, which can be very useful to observe larger-scale trends. Download the `LiH-coex-run.xyze` file and plot it using [Ovito](https://www.google.com/url?q=https://www.ovito.org/&sa=D&source=editors&ust=1747677490682512&usg=AOvVaw2VqepNyiTEvSQOrl77JCjf). You may want to reduce the size of the Li atoms so as to be better able to observe the hydrogen. Is the solid melting or the liquid solidifying? Do we still have coexistence? Plot also `LiH-coex.track` to see which temperature changes are induced by these processes. You can download the file again after a few minutes and check how much further the simulation has progressed.\
`run_coex.sh` is set up to run for 200 ps. There are two things worth noting about this runtime. Firstly, it will take a few hours and so will run beyond this practical. This is no problem! Just take it home with you and look at it again in a few hours. Secondly, however, 200 ps is likely much longer than you actually need to equilibrate the calculation. ~25 ps usually suffice for this. You will note from `Li-coex.track` that the temperature is not actually constant from one timestep to the next. How should we deal with this? Might it be the reason we run for longer than the ~25 ps necessary to equilibrate?

## Wider structure search

Use the EDDP from section 2 for a structure search covering an even wider range of stoichiometries. How far out of the training set can you go and still find useful structures? Does the potential convex hull get worse compared to the DFT-refined outcome as you go further from LiH3?

## 4\. Further reading


-   [This paper](https://www.google.com/url?q=https://journals.aps.org/prb/abstract/10.1103/PhysRevB.106.014102&sa=D&source=editors&ust=1747677490685064&usg=AOvVaw23qY3AypGN8tDYjMZ_Fnic) introduces the EDDPs and explains all their main ingredients.
-   [This paper](https://www.google.com/url?q=https://pubs.aip.org/aip/jcp/article/159/14/144801/2916014&sa=D&source=editors&ust=1747677490685239&usg=AOvVaw38J3foUSTKrfywUC1tgWKy) showcases a wider range of applications of the EDDPs, including lattice and molecular dynamics. It also includes a series of recommendations and best practices regarding the training and use of EDDPs.
-   [This paper](https://www.google.com/url?q=https://journals.aps.org/prb/abstract/10.1103/PhysRevB.49.3109&sa=D&source=editors&ust=1747677490685544&usg=AOvVaw1vsbetV1ma1dUdAUaez5e8) provides an explanation and one of the first examples of the use of coexistence MD.

* * * * *

[1] This also means - hopefully obviously - that you should not put `-exec castep.mpi`.\
[2] NPH: The **isoenthalpic-isobaric ensemble** (constant enthalpy and constant pressure ensemble) is a [statistical mechanical](https://en.wikipedia.org/wiki/Statistical_mechanics) [ensemble](https://en.wikipedia.org/wiki/Statistical_ensemble) that maintains constant enthalpy and constant pressure applied. [https://en.wikipedia.org/wiki/Isoenthalpic--isobaric_ensemble](https://en.wikipedia.org/wiki/Isoenthalpic%E2%80%93isobaric_ensemble)
